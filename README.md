# AntiSpamBot для групп Telegram
[![License: GPL v3](https://img.shields.io/badge/License-GPL%20v3-blue.svg)](./LICENSE)  

Бот предназначен для защиты групп Telegram от спама, ботов и нежелательного контента.

## Основные функции
- Проверка новых пользователей с помощью CAPTCHA в виде вопроса с вариантами ответов
- Автоматическая блокировка пользователей, не прошедших проверку за указанное время
- Подтверждение новых ботов администраторами группы
- Защита от флуда при массовом присоединении пользователей
- Удаление системных сообщений и сообщений о выходе пользователей
- Настройки для каждой группы отдельно

## Команды бота
| Команда | Описание |
|---------|----------|
| `/start` | Показывает приветственное сообщение и информацию о функциях бота |
| `/help` | Показывает полный список команд и возможностей бота |
| `/source` | Отображает ссылку на исходный код и версию бота |
| `/settings` | Открывает меню настроек (только для администраторов) |
| `/admins` или `/admin` | Упоминает всех администраторов группы |
| `/ban` | Блокирует пользователя (только для администраторов) |
| `/cancel` | Отменяет процесс настройки (только для администраторов) |

## Настройки бота
Администраторы могут настроить следующие параметры, используя команду `/settings`:

- **Приветствие**: Текст приветственного сообщения для новых пользователей
- **Вопросы проверки**: Вопросы с вариантами ответов для проверки новых участников
- **Сообщение успешной проверки**: Текст, отображаемый при успешном прохождении проверки
- **Сообщение при отсутствии необходимости в проверке**: Текст для пользователей, нажимающих кнопки не своей проверки
- **Время ожидания проверки**: Время в секундах для прохождения проверки (1-3600)
- **Минимальное динамическое время проверки**: Минимальное значение для динамического времени проверки
- **Время разбана**: Время автоматического разбана после неудачной проверки (0 для постоянного бана)
- **Защита от флуда**: Количество новых пользователей для включения режима защиты от флуда
- **Удаление сообщений о выходе**: Включение/отключение удаления сообщений о выходе пользователей
- **Удаление системных сообщений**: Включение/отключение удаления всех системных сообщений

## Структура проекта
Проект состоит из следующих основных файлов:
- **bot.py**: Основной файл бота, содержащий логику обработки команд и сообщений
- **chatsettings.py**: Настройки для групповых чатов
- **config.py**: Конфигурация бота (API токены и др.)
- **userfilter.py**: Модуль для фильтрации пользователей и определения спам-вероятности
- **utils.py**: Вспомогательные функции
- **bot_backend.py**: Базовая реализация API для блокировки пользователей
- **userbot_backend.py**: Альтернативная реализация API через пользовательского бота
- **mwt.py**: Класс для кэширования с временным ограничением (Memoize With Timeout)
- **ratelimited.py**: Реализация ограничения скорости запросов

## Оптимизация производительности
Для улучшения производительности бота можно использовать следующие подходы:
1. **Настройка параметров кэширования**: Увеличить или уменьшить время жизни кэшированных данных
2. **Ограничение объема хранимых сообщений**: Настройка `STORE_CHAT_MESSAGES` в config.py
3. **Настройка периода очистки памяти**: Изменение `GARBAGE_COLLECTION_INTERVAL` в config.py
4. **Оптимизация вопросов CAPTCHA**: Не создавайте слишком много вариантов вопросов
5. **Настройка защиты от флуда**: Подберите оптимальное значение `FLOOD_LIMIT` для ваших групп

## Установка и настройка

### Способ 1: Только с Bot API
1. Скопируйте `config.py.example` в `config.py`.  
2. Получите [токен бота](https://core.telegram.org/bots#6-botfather).  
3. Измените TOKEN на полученный токен и SALT на любую строку в файле [config.py](https://github.com/l1v0n1/AntiSpamBot-russian/blob/master/config.py.example#L2).  
4. Установите зависимости: `pip3 install -r requirements.txt`    
5. Запустите бота: `python3 bot.py`.  

### Способ 2: С пользовательским MTProto API
#### Полезно, когда у вас есть административный аккаунт без права добавления новых администраторов
1. Получите токен бота и измените TOKEN и SALT в config.py, как указано выше.
2. Получите [API ID и хеш](https://docs.telethon.dev/en/latest/basic/signing-in.html#signing-in) для своего аккаунта Telegram.
3. Укажите свои api_id и hash [здесь](https://github.com/l1v0n1/AntiSpamBot-russian/blob/master/config.py.example#L52).
4. Установите [USER_BOT_BACKEND](https://github.com/l1v0n1/AntiSpamBot-russian/blob/master/config.py.example#L51) в значение `True`.
5. Установите зависимости: `pip3 install -r requirements-userbot.txt`
6. Запустите бота: `python3 bot.py`.

## Использование
1. Добавьте бота в вашу группу.
2. Сделайте бота администратором с правами на блокировку пользователей.
3. Настройте бота с помощью команды `/settings`.

## Требования к системе
- Python 3.8 или выше
- Зависимости из requirements.txt
- Примерно 100 MB оперативной памяти
- Постоянное подключение к интернету

## Устранение неполадок
1. **Проблемы с кэшем**: Удалите файл antispambot.pickle и перезапустите бота
2. **Ошибки с базой данных**: Убедитесь, что у бота есть права на запись в текущую директорию
3. **Сбои при блокировке пользователей**: Проверьте, что бот имеет права администратора с возможностью блокировки
4. **Высокое потребление памяти**: Уменьшите параметр STORE_CHAT_MESSAGES и увеличьте частоту сборки мусора

## Вклад в проект
Пулл-реквесты приветствуются. Пожалуйста, убедитесь, что ваш код соответствует стилю проекта.
